<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline'; img-src 'self' data:;">
<meta name="theme-color" content="#F8F9FA">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>ì¼ì¼ ì„±ê³¼ ê¸°ë¡</title>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #F8F9FA;
  --card: #FFFFFF;
  --primary: #4A6CF7;
  --primary-shadow: rgba(74, 108, 247, 0.3);
  --text: #1A1A2E;
  --text-secondary: #666;
  --text-muted: #888;
  --input-bg: #F4F5F7;
  --border: #E8E8E8;
  --danger: #EF4444;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html, body {
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
}

body {
  display: flex;
  flex-direction: column;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
}

/* â”€â”€ Tab Content â”€â”€ */
.tab-content {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 20px 20px calc(68px + var(--safe-bottom));
}

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* â”€â”€ Date Row â”€â”€ */
.date-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}

.date-arrow {
  font-size: 24px;
  background: none;
  border: none;
  color: var(--primary);
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 8px;
  transition: background 0.15s;
  font-family: inherit;
}

.date-arrow:hover { background: var(--input-bg); }
.date-arrow:disabled { opacity: 0.25; cursor: default; }
.date-arrow:disabled:hover { background: none; }

.date-center { text-align: center; cursor: pointer; }

.date-header {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 0;
}

.date-hint {
  font-size: 11px;
  color: var(--primary);
  margin-top: 2px;
}

.greeting {
  font-size: 14px;
  color: var(--text-muted);
  margin-bottom: 24px;
  text-align: center;
}

.greeting strong { color: var(--primary); }

/* â”€â”€ Card â”€â”€ */
.card {
  background: var(--card);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 8px;
  margin-top: 12px;
}

.label:first-child { margin-top: 0; }
.label .required { color: var(--danger); }
.label .optional { color: #aaa; font-size: 12px; font-weight: 400; }

.input, .textarea {
  width: 100%;
  background: var(--input-bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px;
  font-size: 15px;
  color: #333;
  outline: none;
  transition: border-color 0.2s;
  font-family: inherit;
}

.input:focus, .textarea:focus {
  border-color: var(--primary);
}

.textarea {
  min-height: 80px;
  resize: vertical;
}

.input::placeholder, .textarea::placeholder {
  color: #aaa;
}

/* â”€â”€ Button â”€â”€ */
.btn-save {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 16px;
  background: var(--primary);
  color: #FFF;
  font-size: 16px;
  font-weight: 700;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 4px 8px var(--primary-shadow);
  transition: opacity 0.2s, transform 0.1s;
  font-family: inherit;
}

.btn-save:active {
  transform: scale(0.98);
  opacity: 0.9;
}

.btn-save:disabled {
  opacity: 0.6;
  cursor: default;
}

.btn-save .shortcut {
  opacity: 0.5;
  font-size: 12px;
  font-weight: 400;
}

/* â”€â”€ Records List â”€â”€ */
.section-header {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 10px;
}

.section-header.today {
  color: var(--primary);
}

.section-header.today::before {
  content: '';
  display: inline-block;
  width: 8px;
  height: 8px;
  background: var(--primary);
  border-radius: 50%;
  margin-right: 8px;
  vertical-align: middle;
}

.section { margin-bottom: 20px; }

.record-card {
  background: var(--card);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  position: relative;
}

.record-card.editing {
  border: 2px solid var(--primary);
  box-shadow: none;
}

.record-task {
  font-size: 15px;
  font-weight: 500;
  color: #333;
  line-height: 1.5;
  margin-bottom: 8px;
  padding-right: 56px;
}

.record-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
  font-size: 13px;
}

.record-meta.metric { color: var(--primary); font-weight: 600; }
.record-meta.impact { color: var(--text-secondary); }

.record-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 4px;
}

.btn-action {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 15px;
  color: #ccc;
  padding: 4px;
  line-height: 1;
  transition: color 0.2s;
}

.btn-action.edit:hover { color: var(--primary); }
.btn-action.delete:hover { color: var(--danger); }

/* â”€â”€ Edit Form (inline) â”€â”€ */
.edit-form { margin-top: 0; }
.edit-form .input, .edit-form .textarea {
  margin-bottom: 8px;
  padding: 12px;
  font-size: 14px;
}
.edit-form .textarea { min-height: 60px; }
.edit-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 4px;
}
.edit-actions button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
}
.edit-actions .cancel { background: var(--input-bg); color: var(--text); }
.edit-actions .save { background: var(--primary); color: #fff; }

/* â”€â”€ Empty State â”€â”€ */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 40px;
  text-align: center;
}

.empty-icon { font-size: 48px; margin-bottom: 16px; }
.empty-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
.empty-text { font-size: 14px; color: var(--text-muted); margin-bottom: 20px; }
.empty-cta {
  display: inline-block;
  padding: 14px 32px;
  background: var(--primary);
  color: #fff;
  font-size: 15px;
  font-weight: 700;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-family: inherit;
}

/* â”€â”€ Bottom Tab Bar â”€â”€ */
.tab-bar {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 480px;
  display: flex;
  background: var(--card);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
  padding: 8px 0 calc(8px + var(--safe-bottom));
  z-index: 100;
}

.tab-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 6px 0;
  background: none;
  border: none;
  cursor: pointer;
  font-family: inherit;
  transition: color 0.2s;
  color: #999;
}

.tab-item.active { color: var(--primary); }
.tab-icon { font-size: 20px; line-height: 1; }
.tab-label { font-size: 12px; font-weight: 600; }

/* â”€â”€ Toast â”€â”€ */
.toast {
  position: fixed;
  top: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: #333;
  color: #fff;
  padding: 12px 24px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  z-index: 200;
  opacity: 0;
  transition: transform 0.3s ease, opacity 0.3s ease;
  pointer-events: none;
  white-space: nowrap;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

/* â”€â”€ Confirm Dialog â”€â”€ */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 300;
  align-items: center;
  justify-content: center;
}

.overlay.show { display: flex; }

.dialog {
  background: var(--card);
  border-radius: 16px;
  padding: 24px;
  width: 280px;
  text-align: center;
}

.dialog-title {
  font-size: 17px;
  font-weight: 700;
  margin-bottom: 8px;
}

.dialog-message {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 20px;
}

.dialog-actions {
  display: flex;
  gap: 10px;
}

.dialog-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
}

.dialog-btn.cancel {
  background: var(--input-bg);
  color: var(--text);
}

.dialog-btn.danger {
  background: var(--danger);
  color: #fff;
}

/* â”€â”€ Export Bar â”€â”€ */
.export-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.btn-export {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  cursor: pointer;
  font-family: inherit;
  transition: border-color 0.2s, background 0.2s;
}

.btn-export:active {
  background: var(--input-bg);
}

.btn-export .export-icon {
  font-size: 15px;
}
</style>
</head>
<body>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Confirm Dialog -->
<div class="overlay" id="overlay">
  <div class="dialog">
    <div class="dialog-title">ì‚­ì œ</div>
    <div class="dialog-message">ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
    <div class="dialog-actions">
      <button class="dialog-btn cancel" id="dialogCancel">ì·¨ì†Œ</button>
      <button class="dialog-btn danger" id="dialogConfirm">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- Tab Content -->
<div class="tab-content" id="tabContent">
  <!-- Home Panel -->
  <div class="tab-panel active" id="panelHome" role="tabpanel">
    <div class="date-row">
      <button class="date-arrow" id="prevDate">&#8249;</button>
      <div class="date-center" id="dateCenterBtn">
        <div class="date-header" id="dateHeader"></div>
        <div class="date-hint" id="dateHint" style="display:none">íƒ­í•˜ì—¬ ì˜¤ëŠ˜ë¡œ ì´ë™</div>
      </div>
      <button class="date-arrow" id="nextDate" disabled>&#8250;</button>
    </div>
    <div class="greeting" id="greeting">ì˜¤ëŠ˜ì˜ ì„±ê³¼ë¥¼ ê¸°ë¡í•˜ì„¸ìš”</div>

    <div class="card">
      <label class="label" for="inputTask">ì˜¤ëŠ˜ í•œ ì¼ <span class="required">*</span></label>
      <textarea class="textarea" id="inputTask" placeholder="ì–´ë–¤ ì¼ì„ í–ˆë‚˜ìš”?" maxlength="2000"></textarea>

      <label class="label" for="inputMetric">ìˆ˜ì¹˜ <span class="optional">(ì„ íƒ)</span></label>
      <input class="input" id="inputMetric" placeholder="ì˜ˆ: ì—ëŸ¬ ë¡œê·¸ 40% ê°ì†Œ" maxlength="500">

      <label class="label" for="inputImpact">ì„íŒ©íŠ¸ <span class="optional">(ì„ íƒ)</span></label>
      <input class="input" id="inputImpact" placeholder="ì™œ ì¤‘ìš”í•œì§€ í•œ ì¤„ë¡œ" maxlength="500">
    </div>

    <button class="btn-save" id="btnSave">
      <span>ì €ì¥í•˜ê¸°</span>
      <span class="shortcut">Ctrl+Enter</span>
    </button>
  </div>

  <!-- Records Panel -->
  <div class="tab-panel" id="panelRecords" role="tabpanel">
    <div class="export-bar" id="exportBar" style="display:none">
      <button class="btn-export" id="btnExportTxt">
        <span class="export-icon">ğŸ“„</span> TXT ë‚´ë³´ë‚´ê¸°
      </button>
      <button class="btn-export" id="btnExportCsv">
        <span class="export-icon">ğŸ“Š</span> CSV ë‚´ë³´ë‚´ê¸°
      </button>
    </div>
    <div id="recordsList"></div>
  </div>
</div>

<!-- Tab Bar -->
<nav class="tab-bar" role="tablist">
  <button class="tab-item active" role="tab" aria-selected="true" aria-controls="panelHome" data-tab="panelHome">
    <span class="tab-icon">âœï¸</span>
    <span class="tab-label">ê¸°ë¡í•˜ê¸°</span>
  </button>
  <button class="tab-item" role="tab" aria-selected="false" aria-controls="panelRecords" data-tab="panelRecords">
    <span class="tab-icon">ğŸ“‹</span>
    <span class="tab-label">ê¸°ë¡ ëª©ë¡</span>
  </button>
</nav>

<script>
(function () {
  // â”€â”€ Storage â”€â”€
  const STORAGE_KEY = 'work_journal_achievements';

  function load() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
    catch { return []; }
  }

  function save(list) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    } catch {
      showToast('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤');
    }
  }

  // â”€â”€ Date Helpers â”€â”€
  const DAYS = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

  function formatDate(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function displayDate(d) {
    return `${d.getFullYear()}ë…„ ${d.getMonth() + 1}ì›” ${d.getDate()}ì¼ (${DAYS[d.getDay()]})`;
  }

  function sectionDate(str) {
    const [y, m, d] = str.split('-').map(Number);
    const dt = new Date(y, m - 1, d);
    return `${m}ì›” ${d}ì¼ (${DAYS[dt.getDay()]})`;
  }

  function isSameDay(a, b) {
    return formatDate(a) === formatDate(b);
  }

  // â”€â”€ DOM â”€â”€
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  const tabContent = $('#tabContent');
  const dateHeader = $('#dateHeader');
  const dateHint = $('#dateHint');
  const dateCenterBtn = $('#dateCenterBtn');
  const prevDateBtn = $('#prevDate');
  const nextDateBtn = $('#nextDate');
  const greeting = $('#greeting');
  const inputTask = $('#inputTask');
  const inputMetric = $('#inputMetric');
  const inputImpact = $('#inputImpact');
  const btnSave = $('#btnSave');
  const recordsList = $('#recordsList');
  const toast = $('#toast');
  const overlay = $('#overlay');
  const dialogCancel = $('#dialogCancel');
  const dialogConfirm = $('#dialogConfirm');

  // â”€â”€ Selected Date State â”€â”€
  let selectedDate = new Date();

  function updateDateUI() {
    const isToday = isSameDay(selectedDate, new Date());
    dateHeader.textContent = displayDate(selectedDate);
    dateHint.style.display = isToday ? 'none' : 'block';
    nextDateBtn.disabled = isToday;

    // Update greeting with count
    const list = load();
    const dateStr = formatDate(selectedDate);
    const count = list.filter(a => a.date === dateStr).length;
    if (count === 0) {
      greeting.innerHTML = isToday ? 'ì˜¤ëŠ˜ì˜ ì„±ê³¼ë¥¼ ê¸°ë¡í•˜ì„¸ìš”' : 'ì´ ë‚ ì˜ ì„±ê³¼ë¥¼ ê¸°ë¡í•˜ì„¸ìš”';
    } else {
      greeting.innerHTML = `<strong>${count}ê±´</strong> ê¸°ë¡ë¨`;
    }
  }

  function shiftDate(days) {
    const d = new Date(selectedDate);
    d.setDate(d.getDate() + days);
    const now = new Date();
    now.setHours(23, 59, 59, 999);
    if (d <= now) {
      selectedDate = d;
      updateDateUI();
    }
  }

  prevDateBtn.addEventListener('click', () => shiftDate(-1));
  nextDateBtn.addEventListener('click', () => shiftDate(1));
  dateCenterBtn.addEventListener('click', () => {
    if (!isSameDay(selectedDate, new Date())) {
      selectedDate = new Date();
      updateDateUI();
    }
  });

  updateDateUI();

  // â”€â”€ Toast â”€â”€
  let toastTimer;
  function showToast(msg) {
    clearTimeout(toastTimer);
    toast.textContent = msg;
    toast.classList.add('show');
    toastTimer = setTimeout(() => toast.classList.remove('show'), 2000);
  }

  // â”€â”€ Confirm Dialog â”€â”€
  let pendingDeleteId = null;

  function showConfirm(id) {
    pendingDeleteId = id;
    overlay.classList.add('show');
  }

  dialogCancel.addEventListener('click', () => {
    overlay.classList.remove('show');
    pendingDeleteId = null;
  });

  dialogConfirm.addEventListener('click', () => {
    if (pendingDeleteId !== null) {
      const list = load().filter(a => a.id !== pendingDeleteId);
      save(list);
      renderRecords();
      showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    }
    overlay.classList.remove('show');
    pendingDeleteId = null;
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('show');
      pendingDeleteId = null;
    }
  });

  // â”€â”€ Save â”€â”€
  let isSaving = false;

  function doSave() {
    if (isSaving) return;

    const task = inputTask.value.trim();
    if (!task) {
      showToast("'ì˜¤ëŠ˜ í•œ ì¼'ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
      inputTask.focus();
      return;
    }

    isSaving = true;
    btnSave.disabled = true;

    try {
      const now = new Date();
      const entry = {
        id: `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
        date: formatDate(selectedDate),
        task: task,
        metric: inputMetric.value.trim(),
        impact: inputImpact.value.trim(),
        createdAt: now.toISOString(),
      };

      const list = load();
      list.unshift(entry);
      save(list);

      inputTask.value = '';
      inputMetric.value = '';
      inputImpact.value = '';

      tabContent.scrollTo({ top: 0, behavior: 'smooth' });
      updateDateUI();
      showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } catch {
      showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      isSaving = false;
      btnSave.disabled = false;
    }
  }

  btnSave.addEventListener('click', doSave);

  // Ctrl+Enter / Cmd+Enter shortcut
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      const homeActive = $('#panelHome').classList.contains('active');
      if (homeActive) {
        e.preventDefault();
        doSave();
      }
    }
  });

  // â”€â”€ Render Records â”€â”€
  let editingId = null;

  function renderRecords() {
    const list = load();
    if (list.length === 0) {
      exportBar.style.display = 'none';
      recordsList.innerHTML =
        '<div class="empty-state">' +
          '<div class="empty-icon">ğŸ“</div>' +
          '<div class="empty-title">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>' +
          '<div class="empty-text">ì²« ë²ˆì§¸ ì„±ê³¼ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”!</div>' +
          '<button class="empty-cta" id="emptyCta">ê¸°ë¡í•˜ëŸ¬ ê°€ê¸°</button>' +
        '</div>';
      return;
    }

    exportBar.style.display = 'flex';

    const todayStr = formatDate(new Date());
    const map = new Map();
    for (const a of list) {
      if (!map.has(a.date)) map.set(a.date, []);
      map.get(a.date).push(a);
    }

    const dates = Array.from(map.keys()).sort((a, b) => b.localeCompare(a));

    let html = '';
    for (const date of dates) {
      const isToday = date === todayStr;
      html += '<div class="section">';
      html += `<div class="section-header${isToday ? ' today' : ''}">${isToday ? 'ì˜¤ëŠ˜' : sectionDate(date)}</div>`;
      for (const item of map.get(date)) {
        const idEsc = escapeHtml(item.id);

        if (editingId === item.id) {
          html += `<div class="record-card editing">`;
          html += `<div class="edit-form">`;
          html += `<textarea class="textarea" data-edit-task="${idEsc}" maxlength="2000">${escapeHtml(item.task)}</textarea>`;
          html += `<input class="input" data-edit-metric="${idEsc}" value="${escapeHtml(item.metric)}" placeholder="ìˆ˜ì¹˜ (ì„ íƒ)" maxlength="500">`;
          html += `<input class="input" data-edit-impact="${idEsc}" value="${escapeHtml(item.impact)}" placeholder="ì„íŒ©íŠ¸ (ì„ íƒ)" maxlength="500">`;
          html += `<div class="edit-actions">`;
          html += `<button class="cancel" data-cancel-edit>ì·¨ì†Œ</button>`;
          html += `<button class="save" data-save-edit="${idEsc}">ì €ì¥</button>`;
          html += `</div></div></div>`;
        } else {
          const taskEsc = escapeHtml(item.task);
          const metricEsc = escapeHtml(item.metric);
          const impactEsc = escapeHtml(item.impact);
          html += `<div class="record-card">`;
          html += `<div class="record-actions">`;
          html += `<button class="btn-action edit" data-edit-id="${idEsc}" title="ìˆ˜ì •">âœ</button>`;
          html += `<button class="btn-action delete" data-delete-id="${idEsc}" title="ì‚­ì œ">âœ•</button>`;
          html += `</div>`;
          html += `<div class="record-task">${taskEsc}</div>`;
          if (item.metric) {
            html += `<div class="record-meta metric"><span>ğŸ“Š</span> ${metricEsc}</div>`;
          }
          if (item.impact) {
            html += `<div class="record-meta impact"><span>ğŸ’¡</span> ${impactEsc}</div>`;
          }
          html += `</div>`;
        }
      }
      html += '</div>';
    }

    recordsList.innerHTML = html;
  }

  // Event delegation for records
  recordsList.addEventListener('click', (e) => {
    const deleteBtn = e.target.closest('[data-delete-id]');
    if (deleteBtn) {
      showConfirm(deleteBtn.dataset.deleteId);
      return;
    }

    const editBtn = e.target.closest('[data-edit-id]');
    if (editBtn) {
      editingId = editBtn.dataset.editId;
      renderRecords();
      return;
    }

    const cancelBtn = e.target.closest('[data-cancel-edit]');
    if (cancelBtn) {
      editingId = null;
      renderRecords();
      return;
    }

    const saveBtn = e.target.closest('[data-save-edit]');
    if (saveBtn) {
      const id = saveBtn.dataset.saveEdit;
      const taskEl = recordsList.querySelector(`[data-edit-task="${CSS.escape(id)}"]`);
      const metricEl = recordsList.querySelector(`[data-edit-metric="${CSS.escape(id)}"]`);
      const impactEl = recordsList.querySelector(`[data-edit-impact="${CSS.escape(id)}"]`);
      if (!taskEl || !taskEl.value.trim()) {
        showToast("'ì˜¤ëŠ˜ í•œ ì¼'ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
        return;
      }
      const list = load();
      const idx = list.findIndex(a => a.id === id);
      if (idx !== -1) {
        list[idx].task = taskEl.value.trim();
        list[idx].metric = metricEl ? metricEl.value.trim() : '';
        list[idx].impact = impactEl ? impactEl.value.trim() : '';
        save(list);
        showToast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
      }
      editingId = null;
      renderRecords();
      return;
    }

    const emptyCta = e.target.closest('#emptyCta');
    if (emptyCta) {
      document.querySelector('[data-tab="panelHome"]').click();
      return;
    }
  });

  function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\n/g, '<br>');
  }

  // â”€â”€ Export â”€â”€
  const exportBar = $('#exportBar');
  const btnExportTxt = $('#btnExportTxt');
  const btnExportCsv = $('#btnExportCsv');

  function downloadFile(filename, content, mime) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  function buildTxt(list) {
    const map = new Map();
    for (const a of list) {
      if (!map.has(a.date)) map.set(a.date, []);
      map.get(a.date).push(a);
    }
    const dates = Array.from(map.keys()).sort((a, b) => b.localeCompare(a));
    let txt = '';
    for (const date of dates) {
      txt += '=== ' + sectionDate(date) + ' (' + date + ') ===\n\n';
      for (const item of map.get(date)) {
        txt += '[ ì˜¤ëŠ˜ í•œ ì¼ ] ' + item.task + '\n';
        if (item.metric) txt += '[ ìˆ˜ì¹˜ ] ' + item.metric + '\n';
        if (item.impact) txt += '[ ì„íŒ©íŠ¸ ] ' + item.impact + '\n';
        txt += '\n';
      }
    }
    return txt.trim();
  }

  function buildCsv(list) {
    const header = 'ë‚ ì§œ,ì˜¤ëŠ˜ í•œ ì¼,ìˆ˜ì¹˜,ì„íŒ©íŠ¸';
    const rows = list.map(a => {
      const esc = (s) => {
        let val = (s || '').replace(/"/g, '""');
        if (/^[=+\-@\t\r]/.test(val)) val = "'" + val;
        return '"' + val + '"';
      };
      return [esc(a.date), esc(a.task), esc(a.metric), esc(a.impact)].join(',');
    });
    return '\uFEFF' + header + '\n' + rows.join('\n');
  }

  btnExportTxt.addEventListener('click', () => {
    const list = load();
    if (list.length === 0) return showToast('ë‚´ë³´ë‚¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤');
    downloadFile('work-journal.txt', buildTxt(list), 'text/plain;charset=utf-8');
    showToast('TXT íŒŒì¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤');
  });

  btnExportCsv.addEventListener('click', () => {
    const list = load();
    if (list.length === 0) return showToast('ë‚´ë³´ë‚¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤');
    downloadFile('work-journal.csv', buildCsv(list), 'text/csv;charset=utf-8');
    showToast('CSV íŒŒì¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤');
  });

  // â”€â”€ Tab Switching â”€â”€
  $$('.tab-item').forEach(btn => {
    btn.addEventListener('click', () => {
      $$('.tab-item').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });
      $$('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
      $('#' + btn.dataset.tab).classList.add('active');

      if (btn.dataset.tab === 'panelRecords') {
        editingId = null;
        renderRecords();
      }
      if (btn.dataset.tab === 'panelHome') {
        updateDateUI();
      }
    });
  });

  // â”€â”€ Initial render â”€â”€
  renderRecords();
})();
</script>
</body>
</html>
